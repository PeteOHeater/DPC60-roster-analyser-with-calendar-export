<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPC60 Roster Analyser</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --apple-bg:#f5f5f7; --aviation-black:#1d1d1f; --accent-red:#e21b22;
      --glass-border:rgba(0,0,0,0.08); --text-secondary:#86868b; --success-green:#16a34a;
      --magenta:#d100d1; --credit-blue:#1565c0;
    }
    body{font-family:'Inter',sans-serif;padding:40px 20px;background:var(--apple-bg);color:var(--aviation-black);-webkit-font-smoothing:antialiased;}
    .card{background:rgba(255,255,255,0.85);backdrop-filter:blur(20px);padding:36px;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,0.04);max-width:1800px;margin:auto;border:1px solid var(--glass-border);}
    h2{font-weight:700;text-align:center;margin:0 0 22px 0;font-size:28px;}
    .controls{display:flex;gap:16px;justify-content:center;margin-bottom:16px;flex-wrap:wrap;}
    .input-group{display:flex;flex-direction:column;gap:8px;min-width:200px;}
    label{font-size:11px;text-transform:uppercase;font-weight:600;color:var(--text-secondary);}
    input[type="number"],input[type="text"]{padding:10px 14px;border:1px solid #d2d2d7;border-radius:10px;font-size:14px;background:white;}
    textarea{
      width:100%;height:170px;padding:14px;border:1px solid #d2d2d7;border-radius:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;box-sizing:border-box;margin-bottom:10px;white-space:pre;
    }

    .button-container{display:flex;justify-content:center;gap:12px;margin:16px 0;flex-wrap:wrap;}
    button{background:var(--aviation-black);color:white;border:none;padding:12px 22px;border-radius:12px;cursor:pointer;font-weight:600;transition:all .2s ease;}
    button:hover{opacity:.92;transform:translateY(-1px);}
    .btn-secondary{background:var(--accent-red);}
    .btn-pdf{background:#3a3a3c;}

    .legend{
      display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      background:#fff;border:1px solid #e5e5e7;border-radius:12px;padding:10px 12px;margin:10px 0 14px 0;
    }
    .legend-item{display:flex;gap:10px;align-items:center;color:#424245;font-size:12px;line-height:1.25;}
    .legend-dot{width:12px;height:12px;border-radius:4px;display:inline-block;flex:0 0 auto;border:1px solid rgba(0,0,0,0.14);background:#f2f2f2;}
    .dot-green{background:#e8f5e9;border-color:rgba(22,163,74,0.35);}
    .dot-amber{background:#fff8e1;border-color:rgba(239,108,0,0.35);}
    .dot-blue{background:#e3f2fd;border-color:rgba(21,101,192,0.35);}
    .dot-magenta{background:rgba(209,0,209,0.10);border-color:rgba(209,0,209,0.35);}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px;}
    th{color:var(--text-secondary);text-transform:uppercase;font-size:10px;padding:10px;border-bottom:1px solid #d2d2d7;text-align:left;}
    td{padding:12px 10px;border-bottom:1px solid #f2f2f2;font-size:13px;vertical-align:middle;}
    
    /* Financial columns border */
    th:nth-child(13), th:nth-child(14),
    td:nth-child(13), td:nth-child(14) {
      border-left: 3px solid var(--accent-red);
      background-color: rgba(226, 27, 34, 0.03);
    }
    
    /* Credit column color */
    td:nth-child(4) {
      color: var(--credit-blue);
      font-weight: 600;
    }
    
    .margin-green{background-color:#e8f5e9;color:#2e7d32;border-radius:6px;font-weight:600;padding:3px 8px;display:inline-block;}
    .margin-blue{background-color:#e3f2fd;color:#1565c0;border-radius:6px;padding:3px 8px;display:inline-block;}
    .margin-amber{background-color:#fff8e1;color:#ef6c00;border-radius:6px;padding:3px 8px;display:inline-block;}
    .extra-net{color:var(--success-green);font-weight:700;}
    .adj-input{width:86px;padding:7px 8px;border:2px solid var(--accent-red);border-radius:10px;text-align:center;font-weight:700;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .export-btn{background:#3a3a3c;font-size:11px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px;border-radius:12px;}
    .notice{padding:12px;color:var(--text-secondary);background:#fff;border:1px solid #e5e5e7;border-radius:12px;margin-top:12px;line-height:1.35;}

    .trigger-text{
      color: var(--magenta);
      font-weight: 800;
    }
    .blocks-pill{
      background: rgba(209,0,209,0.18);
      color: #9c009c;
      border: 1px solid rgba(209,0,209,0.5);
      border-radius: 8px;
      padding: 3px 8px;
      display: inline-block;
      font-weight: 800;
    }
    .trigger-ok{
      background: rgba(22,163,74,0.08);
      color: #167a3b;
      border: 1px solid rgba(22,163,74,0.25);
      border-radius: 8px;
      padding: 3px 8px;
      display: inline-block;
      font-weight: 800;
    }

    /* Rest period styling with threshold colors */
    .rest-critical{
      background: rgba(226, 27, 34, 0.12);
      color: #c62828;
      border: 2px solid var(--accent-red);
      border-radius: 8px;
      padding: 4px 10px;
      display: inline-block;
      font-weight: 800;
    }
    .rest-warning{
      background: rgba(239, 108, 0, 0.12);
      color: #ef6c00;
      border: 2px solid rgba(239, 108, 0, 0.5);
      border-radius: 8px;
      padding: 4px 10px;
      display: inline-block;
      font-weight: 700;
    }
    .rest-ok{
      background: rgba(22,163,74,0.10);
      color: #167a3b;
      border: 1px solid rgba(22,163,74,0.35);
      border-radius: 8px;
      padding: 4px 10px;
      display: inline-block;
      font-weight: 600;
    }
    .rest-info{
      color: var(--text-secondary);
      font-size: 11px;
      font-style: italic;
    }

    /* Export modal (native <dialog>) */
    dialog.export-dialog{
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 16px;
      padding: 18px 16px;
      max-width: 520px;
      width: calc(100% - 24px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
    }
    dialog.export-dialog::backdrop{
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }
    .export-dialog h3{ margin:0 0 10px 0; font-size:16px; }
    .export-dialog p{ margin:0 0 14px 0; color: var(--text-secondary); font-size: 12px; line-height: 1.35; }
    .export-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .export-actions button{ padding:10px 14px; border-radius:12px; font-size:12px; }
    .export-actions .cancel{ background:#e5e5e7; color:#1d1d1f; }
  </style>
</head>

<body>
  <div class="card">
    <h2>DPC60 Roster Analyser</h2>

    <div class="controls">
      <div class="input-group">
        <label>Enter Your Hourly Rate ($)</label>
        <input type="number" id="hourlyRate" value="353" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Enter Desired Tax Rate %</label>
        <input type="number" id="taxRate" value="47" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Bid Period</label>
        <input type="text" id="bidPeriod" readonly style="background:#eee;">
      </div>
    </div>

    <div style="margin-bottom: 16px;">
      <div class="instructions-box" style="background: #fff; border: 2px solid var(--accent-red); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <h3 style="margin: 0 0 12px 0; font-size: 15px; color: var(--accent-red);">üìã How to Get Your Roster File</h3>
        <ol style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 13px;">
          <li>Log into <strong>WebCIS</strong></li>
          <li>Navigate to <strong>"Roster"</strong> menu</li>
          <li>Select <strong>"Send My Roster"</strong></li>
          <li>Choose to send the roster to your <strong>email address</strong></li>
          <li>Open the email and <strong>save the roster text as a .txt file</strong> (copy the text and save it in a text editor, or save the email as text)</li>
          <li>Click the <strong>"Upload Roster File"</strong> button below and select your saved file</li>
        </ol>
        <p style="margin: 12px 0 0 0; padding: 10px; background: #fff8e1; border-left: 3px solid #ef6c00; font-size: 12px; border-radius: 6px;">
          <strong>üí° Tip:</strong> The file must contain the complete roster text from WebCIS, including the pattern section with "Rpt/Rls/Duty/Cred" lines.
        </p>
      </div>
      
      <div style="display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 10px; flex-wrap: wrap;">
        <button class="btn-secondary" onclick="document.getElementById('fileInput').click()" style="font-size: 14px; padding: 14px 24px;">
          üìÅ Upload Roster File
        </button>
        <button onclick="toggleManualPaste()" style="background: #3a3a3c; font-size: 14px; padding: 14px 24px;">
          ‚úèÔ∏è Toggle Manual Paste
        </button>
      </div>
      
      <input type="file" id="fileInput" accept=".txt,.text,text/plain" style="display: none;" onchange="handleFileUpload(event)">
      
      <textarea id="rosterInput" style="display: none;"
        placeholder='Alternatively: In WebCIS select "Roster" ‚Üí "Send My Roster". Copy the entire email text and paste it here.'></textarea>
    </div>

    <div class="legend">
      <div class="legend-item">
        <span class="legend-dot dot-green"></span>
        <span><strong>Green:</strong> Future Pattern is built to DPC60 or it's in the past and has been increased to DPC60.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-amber"></span>
        <span><strong>Amber:</strong> Credit Hours are greater than DPC60.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-blue"></span>
        <span><strong>Blue:</strong> .6 Duty is greater than Credit Hours.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-magenta"></span>
        <span><strong>Magenta:</strong> On Blocks Trigger for DPC60.</span>
      </div>
    </div>

    <div class="button-container">
      <button onclick="processRoster()">Process Roster</button>
      <button class="btn-secondary" onclick="openExportAllDialog()">Export All to Calendar</button>
      <button class="btn-pdf" onclick="createPDF()">üìÑ Create PDF</button>
      <button class="btn-secondary" onclick="exportToEmail()">üìß Email Results</button>
    </div>

    <div id="tableContainer"></div>
  </div>

  <!-- Single row export modal -->
  <dialog id="exportDialog" class="export-dialog">
    <h3>Export event</h3>
    <p>Choose where to export this event.</p>
    <div class="export-actions">
      <button class="cancel" type="button" onclick="closeExportDialog()">Cancel</button>
      <button type="button" onclick="exportChoice('ics')">Apple Calendar (ICS)</button>
      <button type="button" onclick="exportChoice('google')">Google Calendar</button>
    </div>
  </dialog>

  <!-- Export all modal -->
  <dialog id="exportAllDialog" class="export-dialog">
    <h3>Export all events</h3>
    <p>Choose where to export all roster events.</p>
    <div class="export-actions">
      <button class="cancel" type="button" onclick="closeExportAllDialog()">Cancel</button>
      <button type="button" onclick="exportAllChoice('ics')">Apple Calendar (ICS)</button>
      <button type="button" onclick="exportAllChoice('google')">Google Calendar</button>
    </div>
  </dialog>

<!-- Load jsPDF libraries BEFORE your script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
  let state = { rosterData: [], yearFull: "", bidPeriod: "" };

  const monthMap = {
   
