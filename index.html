<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPC 60 Roster Analyser</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --apple-bg:#f5f5f7; --aviation-black:#1d1d1f; --accent-red:#e21b22;
      --glass-border:rgba(0,0,0,0.08); --text-secondary:#86868b; --success-green:#16a34a;
    }
    body{font-family:'Inter',sans-serif;padding:40px 20px;background:var(--apple-bg);color:var(--aviation-black);-webkit-font-smoothing:antialiased;}
    .card{background:rgba(255,255,255,0.85);backdrop-filter:blur(20px);padding:36px;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,0.04);max-width:1500px;margin:auto;border:1px solid var(--glass-border);}
    h2{font-weight:700;text-align:center;margin:0 0 26px 0;font-size:28px;}
    .controls{display:flex;gap:16px;justify-content:center;margin-bottom:20px;flex-wrap:wrap;}
    .input-group{display:flex;flex-direction:column;gap:8px;min-width:180px;}
    label{font-size:11px;text-transform:uppercase;font-weight:600;color:var(--text-secondary);}
    input[type="number"],input[type="text"]{padding:10px 14px;border:1px solid #d2d2d7;border-radius:10px;font-size:14px;background:white;}
    textarea{width:100%;height:160px;padding:14px;border:1px solid #d2d2d7;border-radius:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;box-sizing:border-box;margin-bottom:10px;white-space:pre;}
    .hint{font-size:12px;color:var(--text-secondary);margin:0 0 16px 0;line-height:1.35;}
    .button-container{display:flex;justify-content:center;gap:12px;margin:18px 0;flex-wrap:wrap;}
    button{background:var(--aviation-black);color:white;border:none;padding:12px 22px;border-radius:12px;cursor:pointer;font-weight:600;transition:all .2s ease;}
    button:hover{opacity:.92;transform:translateY(-1px);}
    .btn-secondary{background:var(--accent-red);}
    .btn-outline{background:transparent;color:var(--aviation-black);border:1px solid var(--aviation-black);}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px;}
    th{color:var(--text-secondary);text-transform:uppercase;font-size:10px;padding:10px;border-bottom:1px solid #d2d2d7;text-align:left;}
    td{padding:12px 10px;border-bottom:1px solid #f2f2f2;font-size:13px;vertical-align:middle;}
    .margin-green{background-color:#e8f5e9;color:#2e7d32;border-radius:6px;font-weight:600;padding:3px 8px;display:inline-block;}
    .margin-blue{background-color:#e3f2fd;color:#1565c0;border-radius:6px;padding:3px 8px;display:inline-block;}
    .margin-amber{background-color:#fff8e1;color:#ef6c00;border-radius:6px;padding:3px 8px;display:inline-block;}
    .extra-net{color:var(--success-green);font-weight:700;}
    .adj-input{width:86px;padding:7px 8px;border:2px solid var(--accent-red);border-radius:10px;text-align:center;font-weight:700;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .export-btn{background:#3a3a3c;font-size:11px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px;border-radius:12px;}
    .notice{padding:12px;color:var(--text-secondary);background:#fff;border:1px solid #e5e5e7;border-radius:12px;margin-top:12px;line-height:1.35;}
  </style>
</head>

<body>
  <div class="card">
    <h2>DPC60 Roster Analyser</h2>

    <div class="controls">
      <div class="input-group">
        <label>Hourly Rate ($)</label>
        <input type="number" id="hourlyRate" value="353" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Tax Rate %</label>
        <input type="number" id="taxRate" value="47" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Bid Period</label>
        <input type="text" id="bidPeriod" readonly style="background:#eee;">
      </div>
    </div>

    <textarea id="rosterInput" placeholder="Paste the full WebCis roster text here (including the pattern section at the bottom)."></textarea>
    <div class="hint">
      Reads pattern summary lines containing ‚ÄúRpt #### Rls #### ‚Ä¶ Duty ‚Ä¶ Cred ‚Ä¶‚Äù.<br>
      New S-Off format: HHMM (24h). Example: 2315.
    </div>

    <div class="button-container">
      <button onclick="processRoster()">Process Roster</button>
      <button class="btn-outline" onclick="clearRoster()">Clear</button>
      <button class="btn-secondary" onclick="exportToCalendar()">Export All to Calendar</button>
      <button class="btn-secondary" onclick="exportToEmail()">üìß Email Results</button>
    </div>

    <div id="tableContainer"></div>
  </div>

<script>
  let state = { rosterData: [], monthAbbr: "", yearFull: "" };

  const monthMap = {
    jan:{abbr:"Jan"}, feb:{abbr:"Feb"}, mar:{abbr:"Mar"}, apr:{abbr:"Apr"},
    may:{abbr:"May"}, jun:{abbr:"Jun"}, jul:{abbr:"Jul"}, aug:{abbr:"Aug"},
    sep:{abbr:"Sep"}, oct:{abbr:"Oct"}, nov:{abbr:"Nov"}, dec:{abbr:"Dec"}
  };

  const pad2 = (n) => String(n).padStart(2,'0');

  const formatTime = (m) => {
    const mins = Math.max(0, Math.round(m));
    return `${Math.floor(mins / 60)}:${String(mins % 60).padStart(2,'0')}`;
  };

  const parseTimeHM = (s) => {
    if (!s || !s.includes(':')) return 0;
    const [h, m] = s.split(':').map(Number);
    if (!Number.isFinite(h) || !Number.isFinite(m)) return 0;
    return (h * 60) + m;
  };

  const parseHHMM = (s) => {
    if (!/^\d{4}$/.test(s)) return null;
    const hh = parseInt(s.slice(0,2), 10);
    const mm = parseInt(s.slice(2), 10);
    if (hh > 23 || mm > 59) return null;
    return hh * 60 + mm;
  };

  const getMarginClass = (credit, d60) => {
    if (Math.abs(credit - d60) <= 0.5) return 'margin-green';
    return credit > d60 ? 'margin-amber' : 'margin-blue';
  };

  function dollarsFromCents(cents){
    const sign = cents < 0 ? "-" : "";
    const abs = Math.abs(cents);
    return `${sign}$${(abs / 100).toFixed(2)}`;
  }

  function clearRoster(){
    document.getElementById('rosterInput').value = '';
    document.getElementById('tableContainer').innerHTML = '';
    document.getElementById('bidPeriod').value = '';
    state.rosterData = [];
    state.monthAbbr = "";
    state.yearFull = "";
  }

  function detectMonthYear(text){
    const dated = text.match(/\bDATED\s+(\d{1,2})([A-Za-z]{3})(\d{2,4})\b/i);
    const any = text.match(/\b(\d{1,2})([A-Za-z]{3})(\d{2,4})\b/i);
    const m = dated || any;
    if (!m) return false;

    const monKey = m[2].toLowerCase();
    if (!monthMap[monKey]) return false;

    const yy = m[3];
    state.monthAbbr = monthMap[monKey].abbr;
    state.yearFull = (yy.length === 4) ? yy : `20${yy}`;
    return true;
  }

  function processRoster(){
    const text = document.getElementById('rosterInput').value || "";
    const lines = text.split('\n');

    state.rosterData = [];
    state.monthAbbr = "";
    state.yearFull = "";

    const ok = detectMonthYear(text);
    document.getElementById('bidPeriod').value = ok ? `${state.monthAbbr} ${state.yearFull}` : "";

    const dateLine = /^\s*(\d{1,2})([A-Za-z]{3})\b/;
    const rptLine = /^\s*Rpt\s+(\d{4})\s+Rls\s+(\d{4}).*?(\d{1,2}:\d{2})\s+(\d{1,2}:\d{2})\s*$/;

    let currentDay = null;
    let currentMonKey = null;

    for (const line of lines){
      const d = line.match(dateLine);
      if (d){
        currentDay = pad2(d[1]);
        currentMonKey = d[2].toLowerCase();
      }

      const r = line.match(rptLine);
      if (r && currentDay && currentMonKey){
        const duty = parseTimeHM(r[3]);
        const cred = parseTimeHM(r[4]);

        const monAbbr = monthMap[currentMonKey]?.abbr || d[2];
        const prettyDate = state.yearFull ? `${currentDay} ${monAbbr} ${state.yearFull}` : `${currentDay} ${monAbbr}`;

        state.rosterData.push({
          prettyDate,
          origSOff: r[2],     // Rls is sign-off (from roster)
          origDuty: duty,     // minutes (from roster)
          credit: cred,       // minutes (from roster)
          origD60: duty * 0.6 // minutes (calculated)
        });
      }
    }

    renderTable(ok);
  }

  function renderTable(monthYearDetected){
    if (!state.rosterData.length){
      document.getElementById('tableContainer').innerHTML =
        `<div class="notice">No pattern ‚ÄúRpt/Rls/Duty/Cred‚Äù lines detected. Paste the bottom pattern section.</div>`;
      return;
    }

    let notice = "";
    if (!monthYearDetected){
      notice = `<div class="notice">Month/year not detected from ‚ÄúDATED ‚Ä¶‚Äù. Dates may show day+month only.</div>`;
    }

    let html = `${notice}<table><thead><tr>
      <th>Date</th><th>Orig S-Off</th><th>Duty</th><th>Credit</th><th>.6 Duty</th><th>Margin</th>
      <th>New S-Off</th><th>New Duty</th><th>New .6</th><th>Extra Gross</th><th>Net After Tax</th><th>Action</th>
    </tr></thead><tbody>`;

    state.rosterData.forEach((row, i) => {
      const margin = Math.abs(row.credit - row.origD60);
      html += `<tr>
        <td class="mono" style="white-space:nowrap">${row.prettyDate}</td>
        <td class="mono">${row.origSOff}</td>
        <td class="mono" style="color:var(--text-secondary)">${formatTime(row.origDuty)}</td>
        <td class="mono">${formatTime(row.credit)}</td>
        <td class="mono">${formatTime(row.origD60)}</td>
        <td id="marginCell-${i}"><span class="mono ${getMarginClass(row.credit, row.origD60)}">${formatTime(margin)}</span></td>
        <td><input inputmode="numeric" type="text" maxlength="4" class="adj-input mono" placeholder="HHMM" oninput="calculateAdjustment(${i}, this.value)"></td>
        <td id="newDuty-${i}" class="mono">-</td>
        <td id="newD60-${i}" class="mono">-</td>
        <td id="gross-${i}" class="mono">$0.00</td>
        <td id="net-${i}" class="mono extra-net">$0.00</td>
        <td><button class="export-btn" onclick="exportDay(${i})">üóìÔ∏è Export</button></td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById('tableContainer').innerHTML = html;
  }

  function calculateAdjustment(index, newValRaw){
    const inputs = document.querySelectorAll('.adj-input');
    const newVal = (newValRaw || "").replace(/\D/g,"").slice(0,4);
    if (inputs[index] && inputs[index].value !== newVal) inputs[index].value = newVal;
    if (newVal.length !== 4) return;

    const row = state.rosterData[index];

    // Defaults kept (353 and 47)
    const rate = parseFloat(document.getElementById('hourlyRate').value);
    const hourlyRate = Number.isFinite(rate) ? rate : 353;

    const taxRateIn = parseFloat(document.getElementById('taxRate').value);
    const taxRate = Number.isFinite(taxRateIn) ? taxRateIn : 47;
    const taxMult = 1 - (taxRate / 100);

    const t1 = parseHHMM(row.origSOff);
    const t2base = parseHHMM(newVal);
    if (t1 === null || t2base === null) return;

    let t2 = t2base;
    if (t2 < t1) t2 += 1440; // midnight rollover

    const delta = t2 - t1;                 // minutes
    const finalDuty = row.origDuty + delta; // minutes
    const finalD60 = finalDuty * 0.6;       // minutes

    // Only pay if new .6 > credit AND > original .6
    const shouldPay = (finalD60 > row.credit) && (finalD60 > row.origD60);

    // Pay only the portion above BOTH thresholds
    const payFromMins = Math.max(row.credit, row.origD60); // minutes threshold [web:78]
    const diffMins = shouldPay ? (finalD60 - payFromMins) : 0; // minutes (may be fractional)

    // Money: do it in integer cents to avoid float rounding issues in JS [web:97][web:90]
    // Decide rounding policy for fractional minutes:
    // - ceil: if you earn part of a minute, you get paid the whole minute.
    // - round/floor: change if your agreement differs.
    const payableMins = Math.max(0, Math.ceil(diffMins));

    const rateCentsPerHour = Math.round(hourlyRate * 100);
    const grossCents = Math.round((payableMins * rateCentsPerHour) / 60); // minutes -> hours [web:99]
    const netCents = Math.round(grossCents * taxMult);

    document.getElementById(`newDuty-${index}`).innerText = formatTime(finalDuty);
    document.getElementById(`newD60-${index}`).innerText = formatTime(finalD60);
    document.getElementById(`gross-${index}`).innerText = dollarsFromCents(grossCents);
    document.getElementById(`net-${index}`).innerText = dollarsFromCents(netCents);

    const mCell = document.getElementById(`marginCell-${index}`);
    const spanClass = `mono ${getMarginClass(row.credit, finalD60)}`;
    mCell.innerHTML = `<span class="${spanClass}">${formatTime(Math.abs(row.credit - finalD60))}</span>`;
  }

  function updateAllCalculations(){
    const inputs = document.querySelectorAll('.adj-input');
    inputs.forEach((el, i) => { if (el && el.value) calculateAdjustment(i, el.value); });
  }

  function exportDay(i){
    const row = state.rosterData[i];
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=DPC60+Extension+${encodeURIComponent(row.prettyDate)}`;
    window.open(url, '_blank');
  }
  function exportToCalendar(){ state.rosterData.forEach((_, i) => exportDay(i)); }

  function exportToEmail(){
    let body = `DPC60 ANALYSIS\n\n`;
    state.rosterData.forEach(r => body += `${r.prettyDate}: Margin ${formatTime(Math.abs(r.credit - r.origD60))}\n`);
    window.location.href = `mailto:?subject=Roster Analysis&body=${encodeURIComponent(body)}`;
  }
</script>
</body>
</html>
