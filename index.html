<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPC60 Roster Analyser</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --apple-bg:#f5f5f7; --aviation-black:#1d1d1f; --accent-red:#e21b22;
      --glass-border:rgba(0,0,0,0.08); --text-secondary:#86868b; --success-green:#16a34a;
      --magenta:#d100d1;
    }
    body{font-family:'Inter',sans-serif;padding:40px 20px;background:var(--apple-bg);color:var(--aviation-black);-webkit-font-smoothing:antialiased;}
    .card{background:rgba(255,255,255,0.85);backdrop-filter:blur(20px);padding:36px;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,0.04);max-width:1700px;margin:auto;border:1px solid var(--glass-border);}
    h2{font-weight:700;text-align:center;margin:0 0 22px 0;font-size:28px;}
    .controls{display:flex;gap:16px;justify-content:center;margin-bottom:16px;flex-wrap:wrap;}
    .input-group{display:flex;flex-direction:column;gap:8px;min-width:180px;}
    label{font-size:11px;text-transform:uppercase;font-weight:600;color:var(--text-secondary);}
    input[type="number"],input[type="text"]{padding:10px 14px;border:1px solid #d2d2d7;border-radius:10px;font-size:14px;background:white;}
    textarea{
      width:100%;height:170px;padding:14px;border:1px solid #d2d2d7;border-radius:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;box-sizing:border-box;margin-bottom:10px;white-space:pre;
    }

    .button-container{display:flex;justify-content:center;gap:12px;margin:16px 0;flex-wrap:wrap;}
    button{background:var(--aviation-black);color:white;border:none;padding:12px 22px;border-radius:12px;cursor:pointer;font-weight:600;transition:all .2s ease;}
    button:hover{opacity:.92;transform:translateY(-1px);}
    .btn-secondary{background:var(--accent-red);}

    .legend{
      display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      background:#fff;border:1px solid #e5e5e7;border-radius:12px;padding:10px 12px;margin:10px 0 14px 0;
    }
    .legend-item{display:flex;gap:10px;align-items:center;color:#424245;font-size:12px;line-height:1.25;}
    .legend-dot{width:12px;height:12px;border-radius:4px;display:inline-block;flex:0 0 auto;border:1px solid rgba(0,0,0,0.14);background:#f2f2f2;}
    .dot-green{background:#e8f5e9;border-color:rgba(22,163,74,0.35);}
    .dot-amber{background:#fff8e1;border-color:rgba(239,108,0,0.35);}
    .dot-blue{background:#e3f2fd;border-color:rgba(21,101,192,0.35);}
    .dot-magenta{background:rgba(209,0,209,0.10);border-color:rgba(209,0,209,0.35);}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px;}
    th{color:var(--text-secondary);text-transform:uppercase;font-size:10px;padding:10px;border-bottom:1px solid #d2d2d7;text-align:left;}
    td{padding:12px 10px;border-bottom:1px solid #f2f2f2;font-size:13px;vertical-align:middle;}
    .margin-green{background-color:#e8f5e9;color:#2e7d32;border-radius:6px;font-weight:600;padding:3px 8px;display:inline-block;}
    .margin-blue{background-color:#e3f2fd;color:#1565c0;border-radius:6px;padding:3px 8px;display:inline-block;}
    .margin-amber{background-color:#fff8e1;color:#ef6c00;border-radius:6px;padding:3px 8px;display:inline-block;}
    .extra-net{color:var(--success-green);font-weight:700;}
    .adj-input{width:86px;padding:7px 8px;border:2px solid var(--accent-red);border-radius:10px;text-align:center;font-weight:700;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .export-btn{background:#3a3a3c;font-size:11px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px;border-radius:12px;}
    .notice{padding:12px;color:var(--text-secondary);background:#fff;border:1px solid #e5e5e7;border-radius:12px;margin-top:12px;line-height:1.35;}

    .trigger-pill{
      background: rgba(209,0,209,0.10);
      color: var(--magenta);
      border: 1px solid rgba(209,0,209,0.35);
      border-radius: 8px;
      padding: 3px 8px;
      display: inline-block;
      font-weight: 800;
    }
    .trigger-ok{
      background: rgba(22,163,74,0.08);
      color: #167a3b;
      border: 1px solid rgba(22,163,74,0.25);
      border-radius: 8px;
      padding: 3px 8px;
      display: inline-block;
      font-weight: 800;
    }

    /* Export modal (native <dialog>) */
    dialog.export-dialog{
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 16px;
      padding: 18px 16px;
      max-width: 520px;
      width: calc(100% - 24px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
    }
    dialog.export-dialog::backdrop{
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }
    .export-dialog h3{ margin:0 0 10px 0; font-size:16px; }
    .export-dialog p{ margin:0 0 14px 0; color: var(--text-secondary); font-size: 12px; line-height: 1.35; }
    .export-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .export-actions button{ padding:10px 14px; border-radius:12px; font-size:12px; }
    .export-actions .cancel{ background:#e5e5e7; color:#1d1d1f; }
  </style>
</head>

<body>
  <div class="card">
    <h2>DPC60 Roster Analyser</h2>

    <div class="controls">
      <div class="input-group">
        <label>Hourly Rate ($)</label>
        <input type="number" id="hourlyRate" value="353" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Tax Rate %</label>
        <input type="number" id="taxRate" value="47" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Bid Period</label>
        <input type="text" id="bidPeriod" readonly style="background:#eee;">
      </div>
    </div>

    <textarea id="rosterInput"
      placeholder='In WebCis Select "Roster" then "Send My Roster". Send to your email then copy and paste the entire text in here.'></textarea>

    <div class="legend">
      <div class="legend-item">
        <span class="legend-dot dot-green"></span>
        <span><strong>Green:</strong> Pattern is built to DPC60 or increased to DPC60.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-amber"></span>
        <span><strong>Amber:</strong> Credit hours are paid unless the margin is extended.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-blue"></span>
        <span><strong>Blue:</strong> 0.6 duty is greater than credit (0.6 duty is the paid value).</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-magenta"></span>
        <span><strong>Magenta:</strong> Minimum sign-off time needed for 0.6 duty to exceed credit.</span>
      </div>
    </div>

    <div class="button-container">
      <button onclick="processRoster()">Process Roster</button>
      <button class="btn-secondary" onclick="exportToCalendar()">Export All to Calendar</button>
      <button class="btn-secondary" onclick="exportToEmail()">üìß Email Results</button>
    </div>

    <div id="tableContainer"></div>
  </div>

  <!-- Export chooser modal -->
  <dialog id="exportDialog" class="export-dialog">
    <h3>Export event</h3>
    <p>Choose where to export this event.</p>
    <div class="export-actions">
      <button class="cancel" type="button" onclick="closeExportDialog()">Cancel</button>
      <button type="button" onclick="exportChoice('ics')">Apple Calendar (ICS)</button>
      <button type="button" onclick="exportChoice('google')">Google Calendar</button>
    </div>
  </dialog>

<script>
  let state = { rosterData: [], yearFull: "", bidPeriod: "" };

  const monthMap = {
    jan:{abbr:"Jan", num:1}, feb:{abbr:"Feb", num:2}, mar:{abbr:"Mar", num:3}, apr:{abbr:"Apr", num:4},
    may:{abbr:"May", num:5}, jun:{abbr:"Jun", num:6}, jul:{abbr:"Jul", num:7}, aug:{abbr:"Aug", num:8},
    sep:{abbr:"Sep", num:9}, oct:{abbr:"Oct", num:10}, nov:{abbr:"Nov", num:11}, dec:{abbr:"Dec", num:12}
  };

  const pad2 = (n) => String(n).padStart(2,'0');

  const formatTime = (m) => {
    const mins = Math.max(0, Math.round(m));
    return `${Math.floor(mins / 60)}:${String(mins % 60).padStart(2,'0')}`;
  };

  const parseTimeHM = (s) => {
    if (!s || !s.includes(':')) return 0;
    const [h, m] = s.split(':').map(Number);
    if (!Number.isFinite(h) || !Number.isFinite(m)) return 0;
    return (h * 60) + m;
  };

  const parseHHMM = (s) => {
    if (!/^\d{4}$/.test(s)) return null;
    const hh = parseInt(s.slice(0,2), 10);
    const mm = parseInt(s.slice(2), 10);
    if (hh > 23 || mm > 59) return null;
    return hh * 60 + mm;
  };

  const formatHHMM = (mins) => {
    const m = ((mins % 1440) + 1440) % 1440;
    return `${pad2(Math.floor(m / 60))}${pad2(m % 60)}`;
  };

  const getMarginClass = (credit, d60) => {
    if (Math.abs(credit - d60) <= 0.5) return 'margin-green';
    return credit > d60 ? 'margin-amber' : 'margin-blue';
  };

  function detectBidPeriod(text){
    const m = text.match(/\bBid\s*Period\s+(\d+)\b/i);
    if (!m) return false;
    state.bidPeriod = m[1];
    return true;
  }

  function detectYearFromHeader(text){
    const arms = text.match(/\bARMS\s+crew\b[\s\S]*?\b(\d{1,2})([A-Za-z]{3})(\d{2})\s+\d{4}\b/i);
    const qf = text.match(/\bQANTAS\s+AIRWAYS\s+LIMITED\b[\s\S]*?\b(\d{1,2})([A-Za-z]{3})(\d{2})\s+\d{4}\b/i);
    const any = text.match(/\b(\d{1,2})([A-Za-z]{3})(\d{2})\s+\d{4}\b/);

    const m = arms || qf || any;
    if (!m) return false;

    state.yearFull = `20${m[3]}`;
    return true;
  }

  function processRoster(){
    const text = document.getElementById('rosterInput').value || "";
    const lines = text.split('\n');

    state.rosterData = [];
    state.yearFull = "";
    state.bidPeriod = "";

    const bpOk = detectBidPeriod(text);
    const yearOk = detectYearFromHeader(text);

    if (!yearOk) state.yearFull = "2026";
    document.getElementById('bidPeriod').value = bpOk ? `Bid Period ${state.bidPeriod}` : "";

    const dateLine = /^\s*(\d{1,2})([A-Za-z]{3})\b/;
    const rptLine = /^\s*Rpt\s+(\d{4})\s+Rls\s+(\d{4}).*?(\d{1,2}:\d{2})\s+(\d{1,2}:\d{2})\s*$/;

    let currentDay = null;
    let currentMonKey = null;

    for (const line of lines){
      const d = line.match(dateLine);
      if (d){
        currentDay = pad2(d[1]);
        currentMonKey = d[2].toLowerCase();
      }

      const r = line.match(rptLine);
      if (r && currentDay && currentMonKey && monthMap[currentMonKey]){
        const duty = parseTimeHM(r[3]);
        const cred = parseTimeHM(r[4]);

        state.rosterData.push({
          day: parseInt(currentDay, 10),
          monKey: currentMonKey,
          dateLabel: `${currentDay} ${monthMap[currentMonKey].abbr} ${state.yearFull}`.trim(),
          origSOff: r[2],
          origDuty: duty,
          credit: cred,
          origD60: duty * 0.6
        });
      }
    }

    renderTable();
  }

  function computeTriggerSignoff(row){
    const minDutyToBeatCredit = Math.floor(row.credit / 0.6) + 1;
    const deltaNeeded = minDutyToBeatCredit - row.origDuty;

    if (deltaNeeded <= 0) return { already:true, hhmm: row.origSOff, deltaNeeded: 0 };

    const origSoffMins = parseHHMM(row.origSOff);
    if (origSoffMins === null) return { already:false, hhmm:"-", deltaNeeded:null };

    return { already:false, hhmm: formatHHMM(origSoffMins + deltaNeeded), deltaNeeded };
  }

  function dollars(n){
    const v = Number.isFinite(n) ? n : 0;
    const sign = v < 0 ? "-" : "";
    // toFixed renders fixed decimals for currency-like output. [web:421]
    return `${sign}$${Math.abs(v).toFixed(2)}`;
  }

  function renderTable(){
    if (!state.rosterData.length){
      document.getElementById('tableContainer').innerHTML =
        `<div class="notice">No pattern ‚ÄúRpt/Rls/Duty/Cred‚Äù lines detected. Paste the bottom pattern section.</div>`;
      return;
    }

    let html = `<table><thead><tr>
      <th>Date</th><th>Orig S-Off</th><th>Duty</th><th>Credit</th><th>.6 Duty</th><th>Margin</th>
      <th>S-Off to Trigger</th>
      <th>New S-Off</th><th>New Duty</th><th>New .6</th><th>Extra Gross</th><th>Net After Tax</th><th>Action</th>
    </tr></thead><tbody>`;

    state.rosterData.forEach((row, i) => {
      const margin = Math.abs(row.credit - row.origD60);
      const trig = computeTriggerSignoff(row);

      const triggerHTML = trig.already
        ? `<span class="trigger-ok">Already</span>`
        : `<span class="trigger-pill mono" id="trigger-${i}">${trig.hhmm}</span>`;

      html += `<tr>
        <td class="mono" style="white-space:nowrap">${row.dateLabel}</td>
        <td class="mono">${row.origSOff}</td>
        <td class="mono" style="color:var(--text-secondary)">${formatTime(row.origDuty)}</td>
        <td class="mono">${formatTime(row.credit)}</td>
        <td class="mono">${formatTime(row.origD60)}</td>
        <td id="marginCell-${i}"><span class="mono ${getMarginClass(row.credit, row.origD60)}">${formatTime(margin)}</span></td>
        <td>${triggerHTML}</td>

        <td><input inputmode="numeric" type="text" maxlength="4" class="adj-input mono" placeholder="HHMM" oninput="calculateAdjustment(${i}, this.value)"></td>
        <td id="newDuty-${i}" class="mono">-</td>
        <td id="newD60-${i}" class="mono">-</td>
        <td id="gross-${i}" class="mono">$0.00</td>
        <td id="net-${i}" class="mono extra-net">$0.00</td>
        <td><button class="export-btn" onclick="openExportDialog(${i})">üóìÔ∏è Export</button></td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById('tableContainer').innerHTML = html;
  }

  // Second-perfect money: compute paid basis in seconds, then gross/net from seconds.
  function calculateAdjustment(index, newValRaw){
    const inputs = document.querySelectorAll('.adj-input');
    const newVal = (newValRaw || "").replace(/\D/g,"").slice(0,4);
    if (inputs[index] && inputs[index].value !== newVal) inputs[index].value = newVal;
    if (newVal.length !== 4) return;

    const row = state.rosterData[index];

    const rateIn = parseFloat(document.getElementById('hourlyRate').value);
    const hourlyRate = Number.isFinite(rateIn) ? rateIn : 353;

    const taxRateIn = parseFloat(document.getElementById('taxRate').value);
    const taxRate = Number.isFinite(taxRateIn) ? taxRateIn : 47;
    const taxMult = 1 - (taxRate / 100);

    const t1 = parseHHMM(row.origSOff);
    const t2base = parseHHMM(newVal);
    if (t1 === null || t2base === null) return;

    let t2 = t2base;
    if (t2 < t1) t2 += 1440;

    const deltaMins = t2 - t1;
    const finalDutyMins = row.origDuty + deltaMins;
    const finalD60Mins = finalDutyMins * 0.6;

    const creditSec = row.credit * 60;
    const d60_0_sec = row.origDuty * 60 * 0.6;
    const d60_1_sec = finalDutyMins * 60 * 0.6;

    const paid0Sec = Math.max(creditSec, d60_0_sec);
    const paid1Sec = Math.max(creditSec, d60_1_sec);

    let diffSec = paid1Sec - paid0Sec;
    if (diffSec < 0.000001) diffSec = 0;

    const gross = (diffSec / 3600) * hourlyRate;
    const net = gross * taxMult;

    document.getElementById(`newDuty-${index}`).innerText = formatTime(finalDutyMins);
    document.getElementById(`newD60-${index}`).innerText = formatTime(finalD60Mins);

    document.getElementById(`gross-${index}`).innerText = dollars(gross);
    document.getElementById(`net-${index}`).innerText = dollars(net);

    const mCell = document.getElementById(`marginCell-${index}`);
    const spanClass = `mono ${getMarginClass(row.credit, finalD60Mins)}`;
    mCell.innerHTML = `<span class="${spanClass}">${formatTime(Math.abs(row.credit - finalD60Mins))}</span>`;
  }

  function updateAllCalculations(){
    const inputs = document.querySelectorAll('.adj-input');
    inputs.forEach((el, i) => { if (el && el.value) calculateAdjustment(i, el.value); });
  }

  function yyyymmdd(dateObj){
    const y = dateObj.getFullYear();
    const m = pad2(dateObj.getMonth() + 1);
    const d = pad2(dateObj.getDate());
    return `${y}${m}${d}`;
  }

  // Google Calendar export (existing behaviour)
  function exportDay(i){
    const row = state.rosterData[i];

    const year = parseInt(state.yearFull || "2026", 10);
    const monthNum = monthMap[row.monKey].num;
    const startDate = new Date(year, monthNum - 1, row.day);
    const endDate = new Date(year, monthNum - 1, row.day + 1);

    const newD60El = document.getElementById(`newD60-${i}`);
    const newD60Text = newD60El ? (newD60El.innerText || "").trim() : "";
    const d60Mins = (newD60Text && newD60Text !== "-") ? parseTimeHM(newD60Text) : row.origD60;

    const marginMins = Math.abs(row.credit - d60Mins);
    const marginText = formatTime(marginMins);

    const trig = computeTriggerSignoff(row);
    const triggerText = trig.already ? "Already" : trig.hhmm;

    const ZERO_EPS_MIN = 0.5;
    const flag = (marginMins <= ZERO_EPS_MIN) ? "üü† [ZERO MARGIN] " : "";

    const title = `${flag}DPC60 Margin ${marginText} | Sign Off Trigger for DPC60 ${triggerText} (Orig ${row.origSOff})`;
    const dates = `${yyyymmdd(startDate)}/${yyyymmdd(endDate)}`;

    // action=TEMPLATE, text, dates is standard for Google Calendar event links. [web:109]
    const url =
      `https://calendar.google.com/calendar/render?action=TEMPLATE` +
      `&text=${encodeURIComponent(title)}` +
      `&dates=${dates}`;

    window.open(url, "_blank");
  }

  function exportToCalendar(){ state.rosterData.forEach((_, i) => exportDay(i)); }

  // Modal export chooser (<dialog>)
  let exportIndex = null;

  function openExportDialog(i){
    exportIndex = i;
    const dlg = document.getElementById("exportDialog");

    // showModal() displays the dialog as a modal. [web:464]
    if (dlg && typeof dlg.showModal === "function") {
      dlg.showModal();
      return;
    }

    // Fallback if <dialog> unsupported: default to Google Calendar
    exportDay(i);
  }

  function closeExportDialog(){
    const dlg = document.getElementById("exportDialog");
    if (dlg && dlg.open) dlg.close();
    exportIndex = null;
  }

  function exportChoice(which){
    const i = exportIndex;
    closeExportDialog();
    if (i === null || i === undefined) return;

    if (which === "google") exportDay(i);
    if (which === "ics") exportDayICS(i);
  }

  function exportDayICS(i){
    const row = state.rosterData[i];

    const year = parseInt(state.yearFull || "2026", 10);
    const monthNum = monthMap[row.monKey].num;

    // All-day event (same behaviour as Google export)
    const start = new Date(Date.UTC(year, monthNum - 1, row.day, 0, 0, 0));
    const end   = new Date(Date.UTC(year, monthNum - 1, row.day + 1, 0, 0, 0));

    const newD60El = document.getElementById(`newD60-${i}`);
    const newD60Text = newD60El ? (newD60El.innerText || "").trim() : "";
    const d60Mins = (newD60Text && newD60Text !== "-") ? parseTimeHM(newD60Text) : row.origD60;

    const marginMins = Math.abs(row.credit - d60Mins);
    const marginText = formatTime(marginMins);

    const trig = computeTriggerSignoff(row);
    const triggerText = trig.already ? "Already" : trig.hhmm;

    const ZERO_EPS_MIN = 0.5;
    const flag = (marginMins <= ZERO_EPS_MIN) ? "üü† [ZERO MARGIN] " : "";

    const title = `${flag}DPC60 Margin ${marginText} | Trigger ${triggerText} (Orig ${row.origSOff})`;

    const pad2 = (n) => String(n).padStart(2, "0");
    const ymd = (d) => `${d.getUTCFullYear()}${pad2(d.getUTCMonth()+1)}${pad2(d.getUTCDate())}`;

    const dtStamp = (() => {
      const now = new Date();
      return `${now.getUTCFullYear()}${pad2(now.getUTCMonth()+1)}${pad2(now.getUTCDate())}T${pad2(now.getUTCHours())}${pad2(now.getUTCMinutes())}${pad2(now.getUTCSeconds())}Z`;
    })();

    const uid = `dpc60-${year}-${monthNum}-${row.day}-${row.origSOff}@local`;

    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//DPC60 Analyser//EN
CALSCALE:GREGORIAN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtStamp}
SUMMARY:${title.replace(/\n/g, " ")}
DTSTART;VALUE=DATE:${ymd(start)}
DTEND;VALUE=DATE:${ymd(end)}
END:VEVENT
END:VCALENDAR
`;

    const href = "data:text/calendar;charset=utf-8," + encodeURIComponent(ics);
    window.open(href, "_blank");
  }

  function exportToEmail(){
    const bpLabel = state.bidPeriod ? `Bid Period ${state.bidPeriod}` : "Bid Period";
    const subject = `DPC60 Analysis - ${bpLabel}`;

    let body = `DPC60 ANALYSIS - ${bpLabel}\n\n`;

    state.rosterData.forEach(r => {
      const trig = computeTriggerSignoff(r);
      const triggerText = trig.already ? "Already" : trig.hhmm;

      body += `${r.dateLabel}\n`;
      body += `  Orig S-Off: ${r.origSOff}\n`;
      body += `  Sign Off Trigger: ${triggerText}\n`;
      body += `  Margin (Credit vs .6): ${formatTime(Math.abs(r.credit - r.origD60))}\n\n`;
    });

    window.location.href =
      `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }
</script>
</body>
</html>
