function processRoster() {
    const text = document.getElementById('rosterInput').value;
    const lines = text.split('\n');
    rosterData = [];
    const lineRegex = /^(\d{2})\s+([A-Za-z]{3})\s+.*?\s+(\d{4})\s+(\d{4})\s+(\d{1,2}:\d{2})\s+(\d{1,2}:\d{2})/;
    
    let previousDay = 0;
    let monthOffset = 0; // Track when we roll into next month

    lines.forEach((line, index) => {
        const match = line.match(lineRegex);
        if (match) {
            console.log('Matched line:', line);
            
            const currentDay = parseInt(match[1]);
            
            // Detect month rollover: if day number decreases significantly, we've crossed into next month
            if (previousDay > 0 && currentDay < previousDay && (previousDay - currentDay) > 7) {
                monthOffset = 1;
                console.log(`Month rollover detected at day ${currentDay} (previous was ${previousDay})`);
            }
            
            const dutyMins = parseTime(match[5]);
            const credMins = parseTime(match[6]);
            const d60 = dutyMins * 0.6;
            
            rosterData.push({
                id: index, 
                day: match[1],
                dayName: match[2],
                date: `${match[1]} ${match[2]}`,
                monthOffset: monthOffset, // Store which month this duty belongs to
                sOn: match[3], 
                origSOf: match[4],
                origDuty: dutyMins, 
                credit: credMins, 
                origD60: d60
            });
            
            previousDay = currentDay;
        }
    });
    
    if (rosterData.length > 0) {
        console.log('Processed roster data:', rosterData);
    }
    
    renderTable();
}

function parseDate(dateStr, monthOffset) {
    const monthInput = document.getElementById('rosterMonth').value;
    
    if (!monthInput) {
        console.error('Please select a roster month/year');
        alert('Please select the Roster Month/Year at the top before exporting to calendar.');
        return null;
    }
    
    const [year, month] = monthInput.split('-').map(Number);
    const day = parseInt(dateStr.split(' ')[0]);
    
    // Apply month offset for duties in the following month
    let adjustedMonth = month - 1 + monthOffset; // month is 0-indexed in Date
    let adjustedYear = year;
    
    // Handle year rollover (e.g., December roster going into January)
    if (adjustedMonth > 11) {
        adjustedMonth = 0;
        adjustedYear++;
    }
    
    const date = new Date(adjustedYear, adjustedMonth, day);
    
    console.log('Parsed date:', dateStr, 'with offset', monthOffset, '→', date.toDateString());
    return date;
}

function createCalendarEvent(row) {
    const marginMins = Math.abs(row.credit - row.origD60);
    const dutyDate = parseDate(row.date, row.monthOffset); // Pass the monthOffset
    
    if (!dutyDate) {
        return null;
    }
    
    const title = `⚠️ DPC60 Alert: ${formatTime(marginMins)} margin`;
    const description = `DUTY DATE: ${row.date}%0A` +
                      `Scheduled Sign-Off: ${row.origSOf}%0A` +
                      `Duty Time: ${formatTime(row.origDuty)}%0A` +
                      `Credit Hours: ${formatTime(row.credit)}%0A` +
                      `.6 Duty: ${formatTime(row.origD60)}%0A` +
                      `MARGIN: ${formatTime(marginMins)}%0A%0A` +
                      `⚠️ This duty has less than 30 minutes margin between credit hours and DPC60. ` +
                      `Monitor for any delays or extensions that could trigger credit hour payment.`;
    
    const startDate = dutyDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    const endDate = new Date(dutyDate.getTime() + 30*60000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    
    const calUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE` +
                  `&text=${encodeURIComponent(title)}` +
                  `&dates=${startDate}/${endDate}` +
                  `&details=${description}` +
                  `&location=DPC60%20Roster%20Analyser`;
    
    return calUrl;
}
