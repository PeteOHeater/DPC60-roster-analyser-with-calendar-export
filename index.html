<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPC60 Roster Analyser</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --apple-bg:#f5f5f7; --aviation-black:#1d1d1f; --accent-red:#e21b22;
      --glass-border:rgba(0,0,0,0.08); --text-secondary:#86868b; --success-green:#16a34a;
      --magenta:#d100d1; --credit-blue:#1565c0;
    }
    body{font-family:'Inter',sans-serif;padding:40px 20px;background:var(--apple-bg);color:var(--aviation-black);-webkit-font-smoothing:antialiased;}
    .card{background:rgba(255,255,255,0.85);backdrop-filter:blur(20px);padding:36px;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,0.04);max-width:1800px;margin:auto;border:1px solid var(--glass-border);}
    h2{font-weight:700;text-align:center;margin:0 0 22px 0;font-size:28px;}
    .controls{display:flex;gap:16px;justify-content:center;margin-bottom:16px;flex-wrap:wrap;}
    .input-group{display:flex;flex-direction:column;gap:8px;min-width:200px;}
    label{font-size:11px;text-transform:uppercase;font-weight:600;color:var(--text-secondary);}
    input[type="number"],input[type="text"]{padding:10px 14px;border:1px solid #d2d2d7;border-radius:10px;font-size:14px;background:white;}
    textarea{
      width:100%;height:170px;padding:14px;border:1px solid #d2d2d7;border-radius:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;box-sizing:border-box;margin-bottom:10px;white-space:pre;
    }

    .button-container{display:flex;justify-content:center;gap:12px;margin:16px 0;flex-wrap:wrap;}
    button{background:var(--aviation-black);color:white;border:none;padding:12px 22px;border-radius:12px;cursor:pointer;font-weight:600;transition:all .2s ease;}
    button:hover{opacity:.92;transform:translateY(-1px);}
    .btn-secondary{background:var(--accent-red);}
    .btn-pdf{background:#3a3a3c;}

    .legend{
      display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      background:#fff;border:1px solid #e5e5e7;border-radius:12px;padding:10px 12px;margin:10px 0 14px 0;
    }
    .legend-item{display:flex;gap:10px;align-items:center;color:#424245;font-size:12px;line-height:1.25;}
    .legend-dot{width:12px;height:12px;border-radius:4px;display:inline-block;flex:0 0 auto;border:1px solid rgba(0,0,0,0.14);background:#f2f2f2;}
    .dot-green{background:#e8f5e9;border-color:rgba(22,163,74,0.35);}
    .dot-amber{background:#fff8e1;border-color:rgba(239,108,0,0.35);}
    .dot-blue{background:#e3f2fd;border-color:rgba(21,101,192,0.35);}
    .dot-magenta{background:rgba(209,0,209,0.10);border-color:rgba(209,0,209,0.35);}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px;}
    th{color:var(--text-secondary);text-transform:uppercase;font-size:10px;padding:10px;border-bottom:1px solid #d2d2d7;text-align:left;}
    td{padding:12px 10px;border-bottom:1px solid #f2f2f2;font-size:13px;vertical-align:middle;}
    
    /* Financial columns border */
    th:nth-child(13), th:nth-child(14),
    td:nth-child(13), td:nth-child(14) {
      border-left: 3px solid var(--accent-red);
      background-color: rgba(226, 27, 34, 0.03);
    }
    
    /* Credit column color */
    td:nth-child(4) {
      color: var(--credit-blue);
      font-weight: 600;
    }
    
    .margin-green{background-color:#e8f5e9;color:#2e7d32;border-radius:6px;font-weight:600;padding:3px 8px;display:inline-block;}
    .margin-blue{background-color:#e3f2fd;color:#1565c0;border-radius:6px;padding:3px 8px;display:inline-block;}
    .margin-amber{background-color:#fff8e1;color:#ef6c00;border-radius:6px;padding:3px 8px;display:inline-block;}
    .extra-net{color:var(--success-green);font-weight:700;}
    .adj-input{width:86px;padding:7px 8px;border:2px solid var(--accent-red);border-radius:10px;text-align:center;font-weight:700;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .export-btn{background:#3a3a3c;font-size:11px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px;border-radius:12px;}
    .notice{padding:12px;color:var(--text-secondary);background:#fff;border:1px solid #e5e5e7;border-radius:12px;margin-top:12px;line-height:1.35;}

    .trigger-text{
      color: var(--magenta);
      font-weight: 800;
    }
    .blocks-pill{
      background: rgba(209,0,209,0.18);
      color: #9c009c;
      border: 1px solid rgba(209,0,209,0.5);
      border-radius: 8px;
      padding: 3px 8px;
      display: inline-block;
      font-weight: 800;
    }
    .trigger-ok{
      background: rgba(22,163,74,0.08);
      color: #167a3b;
      border: 1px solid rgba(22,163,74,0.25);
      border-radius: 8px;
      padding: 3px 8px;
      display: inline-block;
      font-weight: 800;
    }

    /* Rest period styling with threshold colors */
    .rest-critical{
      background: rgba(226, 27, 34, 0.12);
      color: #c62828;
      border: 2px solid var(--accent-red);
      border-radius: 8px;
      padding: 4px 10px;
      display: inline-block;
      font-weight: 800;
    }
    .rest-warning{
      background: rgba(239, 108, 0, 0.12);
      color: #ef6c00;
      border: 2px solid rgba(239, 108, 0, 0.5);
      border-radius: 8px;
      padding: 4px 10px;
      display: inline-block;
      font-weight: 700;
    }
    .rest-ok{
      background: rgba(22,163,74,0.10);
      color: #167a3b;
      border: 1px solid rgba(22,163,74,0.35);
      border-radius: 8px;
      padding: 4px 10px;
      display: inline-block;
      font-weight: 600;
    }
    .rest-info{
      color: var(--text-secondary);
      font-size: 11px;
      font-style: italic;
    }

    /* Export modal (native <dialog>) */
    dialog.export-dialog{
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 16px;
      padding: 18px 16px;
      max-width: 520px;
      width: calc(100% - 24px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
    }
    dialog.export-dialog::backdrop{
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }
    .export-dialog h3{ margin:0 0 10px 0; font-size:16px; }
    .export-dialog p{ margin:0 0 14px 0; color: var(--text-secondary); font-size: 12px; line-height: 1.35; }
    .export-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .export-actions button{ padding:10px 14px; border-radius:12px; font-size:12px; }
    .export-actions .cancel{ background:#e5e5e7; color:#1d1d1f; }
  </style>
</head>

<body>
  <div class="card">
    <h2>DPC60 Roster Analyser</h2>

    <div class="controls">
      <div class="input-group">
        <label>Enter Your Hourly Rate ($)</label>
        <input type="number" id="hourlyRate" value="353" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Enter Desired Tax Rate %</label>
        <input type="number" id="taxRate" value="47" oninput="updateAllCalculations()">
      </div>
      <div class="input-group">
        <label>Bid Period</label>
        <input type="text" id="bidPeriod" readonly style="background:#eee;">
      </div>
    </div>

    <div style="margin-bottom: 16px;">
      <div class="instructions-box" style="background: #fff; border: 2px solid var(--accent-red); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <h3 style="margin: 0 0 12px 0; font-size: 15px; color: var(--accent-red);">üìã How to Get Your Roster File</h3>
        <ol style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 13px;">
          <li>Log into <strong>WebCIS</strong></li>
          <li>Navigate to <strong>"Roster"</strong> menu</li>
          <li>Select <strong>"Send My Roster"</strong></li>
          <li>Choose to send the roster to your <strong>email address</strong></li>
          <li>Open the email and <strong>save the roster text as a .txt file</strong> (copy the text and save it in a text editor, or save the email as text)</li>
          <li>Click the <strong>"Upload Roster File"</strong> button below and select your saved file</li>
        </ol>
        <p style="margin: 12px 0 0 0; padding: 10px; background: #fff8e1; border-left: 3px solid #ef6c00; font-size: 12px; border-radius: 6px;">
          <strong>üí° Tip:</strong> The file must contain the complete roster text from WebCIS, including the pattern section with "Rpt/Rls/Duty/Cred" lines.
        </p>
      </div>
      
      <div style="display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 10px; flex-wrap: wrap;">
        <button class="btn-secondary" onclick="document.getElementById('fileInput').click()" style="font-size: 14px; padding: 14px 24px;">
          üìÅ Upload Roster File
        </button>
        <button onclick="toggleManualPaste()" style="background: #3a3a3c; font-size: 14px; padding: 14px 24px;">
          ‚úèÔ∏è Toggle Manual Paste
        </button>
      </div>
      
      <input type="file" id="fileInput" accept=".txt,.text,text/plain" style="display: none;" onchange="handleFileUpload(event)">
      
      <textarea id="rosterInput" style="display: none;"
        placeholder='Alternatively: In WebCIS select "Roster" ‚Üí "Send My Roster". Copy the entire email text and paste it here.'></textarea>
    </div>

    <div class="legend">
      <div class="legend-item">
        <span class="legend-dot dot-green"></span>
        <span><strong>Green:</strong> Future Pattern is built to DPC60 or it's in the past and has been increased to DPC60.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-amber"></span>
        <span><strong>Amber:</strong> Credit Hours are greater than DPC60.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-blue"></span>
        <span><strong>Blue:</strong> .6 Duty is greater than Credit Hours.</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot dot-magenta"></span>
        <span><strong>Magenta:</strong> On Blocks Trigger for DPC60.</span>
      </div>
    </div>

    <div class="button-container">
      <button onclick="processRoster()">Process Roster</button>
      <button class="btn-secondary" onclick="openExportAllDialog()">Export All to Calendar</button>
      <button class="btn-pdf" onclick="createPDF()">üìÑ Create PDF</button>
      <button class="btn-secondary" onclick="exportToEmail()">üìß Email Results</button>
    </div>

    <div id="tableContainer"></div>
  </div>

  <!-- Single row export modal -->
  <dialog id="exportDialog" class="export-dialog">
    <h3>Export event</h3>
    <p>Choose where to export this event.</p>
    <div class="export-actions">
      <button class="cancel" type="button" onclick="closeExportDialog()">Cancel</button>
      <button type="button" onclick="exportChoice('ics')">Apple Calendar (ICS)</button>
      <button type="button" onclick="exportChoice('google')">Google Calendar</button>
    </div>
  </dialog>

  <!-- Export all modal -->
  <dialog id="exportAllDialog" class="export-dialog">
    <h3>Export all events</h3>
    <p>Choose where to export all roster events.</p>
    <div class="export-actions">
      <button class="cancel" type="button" onclick="closeExportAllDialog()">Cancel</button>
      <button type="button" onclick="exportAllChoice('ics')">Apple Calendar (ICS)</button>
      <button type="button" onclick="exportAllChoice('google')">Google Calendar</button>
    </div>
  </dialog>

<!-- Load jsPDF libraries BEFORE your script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
  let state = { rosterData: [], yearFull: "", bidPeriod: "" };

  const monthMap = {
    jan:{abbr:"Jan", num:1}, feb:{abbr:"Feb", num:2}, mar:{abbr:"Mar", num:3}, apr:{abbr:"Apr", num:4},
    may:{abbr:"May", num:5}, jun:{abbr:"Jun", num:6}, jul:{abbr:"Jul", num:7}, aug:{abbr:"Aug", num:8},
    sep:{abbr:"Sep", num:9}, oct:{abbr:"Oct", num:10}, nov:{abbr:"Nov", num:11}, dec:{abbr:"Dec", num:12}
  };

  const pad2 = (n) => String(n).padStart(2,'0');

  const formatTime = (m) => {
    const mins = Math.max(0, Math.round(m));
    return `${Math.floor(mins / 60)}:${String(mins % 60).padStart(2,'0')}`;
  };

  const parseTimeHM = (s) => {
    if (!s || !s.includes(':')) return 0;
    const [h, m] = s.split(':').map(Number);
    if (!Number.isFinite(h) || !Number.isFinite(m)) return 0;
    return (h * 60) + m;
  };

  const parseHHMM = (s) => {
    if (!/^\d{4}$/.test(s)) return null;
    const hh = parseInt(s.slice(0,2), 10);
    const mm = parseInt(s.slice(2), 10);
    if (hh > 23 || mm > 59) return null;
    return hh * 60 + mm;
  };

  const formatHHMM = (mins) => {
    const m = ((mins % 1440) + 1440) % 1440;
    return `${pad2(Math.floor(m / 60))}${pad2(m % 60)}`;
  };

  const getMarginClass = (credit, d60) => {
    if (Math.abs(credit - d60) <= 0.5) return 'margin-green';
    return credit > d60 ? 'margin-amber' : 'margin-blue';
  };

  function toggleManualPaste() {
    const textarea = document.getElementById('rosterInput');
    if (textarea.style.display === 'none') {
      textarea.style.display = 'block';
    } else {
      textarea.style.display = 'none';
    }
  }

  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
      alert('File is too large. Please select a file smaller than 5MB.');
      return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const text = e.target.result;
      document.getElementById('rosterInput').value = text;
      processRoster();
      
      const notice = document.createElement('div');
      notice.className = 'notice';
      notice.style.background = '#e8f5e9';
      notice.style.color = '#2e7d32';
      notice.style.marginBottom = '12px';
      notice.innerHTML = `‚úÖ File "${file.name}" uploaded successfully and processed.`;
      
      const container = document.getElementById('tableContainer');
      if (container.firstChild) {
        container.insertBefore(notice, container.firstChild);
      } else {
        container.appendChild(notice);
      }
      
      setTimeout(() => notice.remove(), 5000);
    };
    
    reader.onerror = function() {
      alert('Error reading file. Please try again.');
    };
    
    reader.readAsText(file);
    event.target.value = '';
  }

  function calculateRestPeriod(currentRow, nextRow, newSignOffTime) {
    if (!nextRow || !nextRow.rptTime) return null;
    
    const MIN_REST_HOURS = 10;
    const MIN_REST_MINS = MIN_REST_HOURS * 60;
    const WARNING_THRESHOLD_MINS = 11 * 60;
    
    const currentDate = new Date(parseInt(state.yearFull), monthMap[currentRow.monKey].num - 1, currentRow.day);
    const nextDate = new Date(parseInt(state.yearFull), monthMap[nextRow.monKey].num - 1, nextRow.day);
    const daysDiff = Math.round((nextDate - currentDate) / (1000 * 60 * 60 * 24));
    
    if (daysDiff > 1) {
      return { isGap: true, daysDiff };
    }
    
    const signOffToUse = newSignOffTime || currentRow.origSOff;
    const signOffMins = parseHHMM(signOffToUse);
    if (signOffMins === null) return null;
    
    const nextSignOnMins = parseHHMM(nextRow.rptTime);
    if (nextSignOnMins === null) return null;
    
    let restMins;
    if (daysDiff === 0) {
      restMins = nextSignOnMins - signOffMins;
      if (restMins < 0) {
        return null;
      }
    } else {
      restMins = (nextSignOnMins + (daysDiff * 1440)) - signOffMins;
    }
    
    const restHours = (restMins / 60).toFixed(1);
    const isCritical = restMins < MIN_REST_MINS;
    const isWarning = restMins >= MIN_REST_MINS && restMins < WARNING_THRESHOLD_MINS;
    const isOk = restMins >= WARNING_THRESHOLD_MINS;
    const shortfall = isCritical ? MIN_REST_MINS - restMins : 0;
    const shortfallHours = (shortfall / 60).toFixed(1);
    
    return {
      restMins,
      restHours,
      isCritical,
      isWarning,
      isOk,
      shortfall,
      shortfallHours,
      minRequired: MIN_REST_HOURS,
      isGap: false
    };
  }

  function detectBidPeriod(text){
    const m = text.match(/\bBid\s*Period\s+(\d+)\b/i);
    if (!m) return false;
    state.bidPeriod = m[1];
    return true;
  }

  function detectYearFromHeader(text){
    const arms = text.match(/\bARMS\s+crew\b[\s\S]*?\b(\d{1,2})([A-Za-z]{3})(\d{2})\s+\d{4}\b/i);
    const qf = text.match(/\bQANTAS\s+AIRWAYS\s+LIMITED\b[\s\S]*?\b(\d{1,2})([A-Za-z]{3})(\d{2})\s+\d{4}\b/i);
    const any = text.match(/\b(\d{1,2})([A-Za-z]{3})(\d{2})\s+\d{4}\b/);

    const m = arms || qf || any;
    if (!m) return false;

    state.yearFull = `20${m[3]}`;
    return true;
  }

  function processRoster(){
    const text = document.getElementById('rosterInput').value || "";
    const lines = text.split('\n');

    state.rosterData = [];
    state.yearFull = "";
    state.bidPeriod = "";

    const bpOk = detectBidPeriod(text);
    const yearOk = detectYearFromHeader(text);

    if (!yearOk) state.yearFull = "2026";
    document.getElementById('bidPeriod').value = bpOk ? `Bid Period ${state.bidPeriod}` : "";

    const dateLine = /^\s*(\d{1,2})([A-Za-z]{3})\b/;
    const rptLine = /^\s*Rpt\s+(\d{4})\s+Rls\s+(\d{4}).*?(\d{1,2}:\d{2})\s+(\d{1,2}:\d{2})\s*$/;

    let currentDay = null;
    let currentMonKey = null;

    for (const line of lines){
      const d = line.match(dateLine);
      if (d){
        currentDay = pad2(d[1]);
        currentMonKey = d[2].toLowerCase();
      }

      const r = line.match(rptLine);
      if (r && currentDay && currentMonKey && monthMap[currentMonKey]){
        const duty = parseTimeHM(r[3]);
        const cred = parseTimeHM(r[4]);

        state.rosterData.push({
          day: parseInt(currentDay, 10),
          monKey: currentMonKey,
          dateLabel: `${currentDay} ${monthMap[currentMonKey].abbr} ${state.yearFull}`.trim(),
          rptTime: r[1],
          origSOff: r[2],
          origDuty: duty,
          credit: cred,
          origD60: duty * 0.6
        });
      }
    }

    renderTable();
  }

  function computeTriggerSignoff(row){
    const minDutyToBeatCredit = Math.floor(row.credit / 0.6) + 1;
    const deltaNeeded = minDutyToBeatCredit - row.origDuty;

    if (deltaNeeded <= 0) return { already:true, hhmm: row.origSOff, deltaNeeded: 0 };

    const origSoffMins = parseHHMM(row.origSOff);
    if (origSoffMins === null) return { already:false, hhmm:"-", deltaNeeded:null };

    return { already:false, hhmm: formatHHMM(origSoffMins + deltaNeeded), deltaNeeded };
  }

  function dollars(n){
    const v = Number.isFinite(n) ? n : 0;
    const sign = v < 0 ? "-" : "";
    return `${sign}$${Math.abs(v).toFixed(2)}`;
  }

  function renderTable(){
    if (!state.rosterData.length){
      document.getElementById('tableContainer').innerHTML =
        `<div class="notice">No pattern "Rpt/Rls/Duty/Cred" lines detected. Please upload or paste a valid roster file from WebCIS.</div>`;
      return;
    }

    let html = `<table><thead><tr>
      <th>Date</th><th>Orig S-Off</th><th>Duty</th><th>Credit</th><th>.6 Duty</th><th>Margin Between<br>Credit Hrs and DPC60</th>
      <th>S-OFF Trigger<br>for DPC60</th>
      <th>On Blocks Trigger<br>for DPC60</th>
      <th>New S-OFF<br>Time?</th><th>New Duty</th><th>New .6</th><th>Rest Period<br>(to next duty)</th><th>Extra Gross</th><th>Net After Tax</th><th>Action</th>
    </tr></thead><tbody>`;

    state.rosterData.forEach((row, i) => {
      const margin = Math.abs(row.credit - row.origD60);
      const trig = computeTriggerSignoff(row);
      const nextRow = state.rosterData[i + 1];
      
      const triggerHTML = trig.already
        ? `<span class="trigger-ok">Already</span>`
        : `<span class="trigger-text mono" id="trigger-${i}">${trig.hhmm}</span>`;

      let onBlocksHTML = '<span class="trigger-ok">Already</span>';
      if (!trig.already && trig.hhmm && trig.hhmm !== "-") {
        const trigMins = parseHHMM(trig.hhmm);
        if (trigMins !== null) {
          const blocksMins = trigMins - 15;
          onBlocksHTML = `<span class="blocks-pill mono">${formatHHMM(blocksMins)}</span>`;
        } else {
          onBlocksHTML = "-";
        }
      }

      let restHTML = '<span class="rest-info">Last duty</span>';
      if (nextRow) {
        const rest = calculateRestPeriod(row, nextRow, null);
        if (rest) {
          if (rest.isGap) {
            restHTML = `<span class="rest-info">Days off (${rest.daysDiff - 1}d)</span>`;
          } else if (rest.isCritical) {
            restHTML = `<span class="rest-critical mono">‚ö†Ô∏è ${rest.restHours}hrs (${rest.shortfallHours}hr short)</span>`;
          } else if (rest.isWarning) {
            restHTML = `<span class="rest-warning mono">‚ö†Ô∏è ${rest.restHours}hrs</span>`;
          } else {
            restHTML = `<span class="rest-ok mono">${rest.restHours}hrs ‚úì</span>`;
          }
        } else {
          restHTML = '<span class="rest-info">Enter new S-OFF</span>';
        }
      }

      html += `<tr>
        <td class="mono" style="white-space:nowrap">${row.dateLabel}</td>
        <td class="mono">${row.origSOff}</td>
        <td class="mono" style="color:var(--text-secondary)">${formatTime(row.origDuty)}</td>
        <td class="mono">${formatTime(row.credit)}</td>
        <td class="mono">${formatTime(row.origD60)}</td>
        <td id="marginCell-${i}"><span class="mono ${getMarginClass(row.credit, row.origD60)}">${formatTime(margin)}</span></td>
        <td>${triggerHTML}</td>
        <td>${onBlocksHTML}</td>

        <td><input inputmode="numeric" type="text" maxlength="4" class="adj-input mono" placeholder="HHMM" oninput="calculateAdjustment(${i}, this.value)"></td>
        <td id="newDuty-${i}" class="mono">-</td>
        <td id="newD60-${i}" class="mono">-</td>
        <td id="restPeriod-${i}">${restHTML}</td>
        <td id="gross-${i}" class="mono">$0.00</td>
        <td id="net-${i}" class="mono extra-net">$0.00</td>
        <td><button class="export-btn" onclick="openExportDialog(${i})">üóìÔ∏è Export</button></td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById('tableContainer').innerHTML = html;
  }

  function calculateAdjustment(index, newValRaw){
    const inputs = document.querySelectorAll('.adj-input');
    const newVal = (newValRaw || "").replace(/\D/g,"").slice(0,4);
    if (inputs[index] && inputs[index].value !== newVal) inputs[index].value = newVal;
    if (newVal.length !== 4) return;

    const row = state.rosterData[index];
    const nextRow = state.rosterData[index + 1];

    const rateIn = parseFloat(document.getElementById('hourlyRate').value);
    const hourlyRate = Number.isFinite(rateIn) ? rateIn : 353;

    const taxRateIn = parseFloat(document.getElementById('taxRate').value);
    const taxRate = Number.isFinite(taxRateIn) ? taxRateIn : 47;
    const taxMult = 1 - (taxRate / 100);

    const t1 = parseHHMM(row.origSOff);
    const t2base = parseHHMM(newVal);
    if (t1 === null || t2base === null) return;

    let t2 = t2base;
    if (t2 < t1) t2 += 1440;

    const deltaMins = t2 - t1
